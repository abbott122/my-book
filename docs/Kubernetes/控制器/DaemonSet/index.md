# DaemonSet 控制器
在 Kubernetes 中，**DaemonSet 控制器** 是一种特殊的控制器，它确保**集群中的每个（或部分）节点上都运行一个 Pod 副本**。

与 Deployment 和 StatefulSet 不同，DaemonSet 关注的不是 Pod 的副本数量，而是 Pod 在**每个节点**上的存在。它的主要用途是运行那些需要在每个节点上执行的系统级后台任务。

---

### DaemonSet 的工作原理

DaemonSet 控制器会持续监控集群中的节点。当一个新节点加入集群时，它会自动在上面调度一个 DaemonSet Pod。如果一个节点被移除，该节点上的 Pod 也会被垃圾回收。

这就像一个“守护神”，它会确保你的指定任务在集群的每个角落都始终保持运行。

### 常见的 DaemonSet 用例

DaemonSet 非常适合以下场景：

* **日志收集器**：例如，在每个节点上运行一个 **Fluentd** 或 **Logstash** 代理，负责收集该节点上的所有日志，并将其发送到中央日志系统。
* **监控代理**：在每个节点上运行一个 **Prometheus Node Exporter** 或其他监控代理，用于收集节点的性能指标（CPU、内存、磁盘等）。
* **网络插件**：许多网络插件（如 **Calico** 或 **Flannel**）都以 DaemonSet 的形式部署，以确保每个节点都有一个网络代理来管理其网络。
* **集群存储守护进程**：例如，在每个节点上运行一个存储守护进程，以使节点能够访问特定的存储卷。

---

### DaemonSet 的关键特性

* **一对一节点-Pod 关系**：一个节点上通常只有一个 DaemonSet Pod。除非你明确地配置了选择器，否则 DaemonSet 会部署到所有满足条件的节点上。
* **自动部署**：当新节点加入集群时，DaemonSet 会自动在该节点上创建 Pod，无需手动干预。
* **自动清理**：当节点从集群中移除时，DaemonSet 会自动删除该节点上的 Pod，以释放资源。
* **节点选择器**：你可以使用 **`nodeSelector`** 或 **`affinity`** 来限制 DaemonSet 只在符合特定标签的节点上运行。这对于混合类型的集群非常有用，例如，你可能只想在有 GPU 的节点上运行特定的 DaemonSet。

---

### DaemonSet 与 Deployment 的区别

理解 DaemonSet 的关键是将其与 Deployment 进行对比：

| 特性 | **DaemonSet** | **Deployment** |
| :--- | :--- | :--- |
| **部署策略** | 每个（或部分）节点一个 Pod | 指定数量的 Pod 副本 |
| **主要目标** | 确保每个节点都有后台任务 | 确保应用副本数，提供高可用性 |
| **Pod 数量** | 由集群中符合条件的节点数决定 | 由用户在 `replicas` 中指定 |
| **典型用例** | 日志收集、监控、网络插件 | Web 服务、API 网关、微服务 |

**总结：** 如果你的目标是让一个守护进程在所有节点上运行，那么 **DaemonSet** 是最合适的选择。它通过自动化的方式简化了这类任务的部署和管理，是维护 Kubernetes 集群健康和可观测性的重要工具。